name: Build and Release Just A Sample

on:
  workflow_dispatch:

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      full_version: ${{ steps.calc.outputs.FULL_VERSION }}
      base_version: ${{ steps.calc.outputs.BASE_VERSION }}
      patch_number: ${{ steps.calc.outputs.PATCH }}
    steps:
      - uses: actions/checkout@v4
  
      - id: calc
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_VERSION=$(cmake -DPRINT_VERSION=ON -P version.cmake)
          
          RELEASE_DATA=$(gh release view "v${BASE_VERSION}-latest" --json isDraft,assets 2>/dev/null || echo "")
        
          if [ -z "$RELEASE_DATA" ]; then
            PATCH=0
          else
            IS_DRAFT=$(echo "$RELEASE_DATA" | jq -r '.isDraft')
            ASSETS=$(echo "$RELEASE_DATA" | jq -r '.assets[].name' 2>/dev/null || echo "")
        
            HIGHEST_PATCH=$(echo "$ASSETS" | grep -oP "(?<=v${BASE_VERSION}\.)\d+" | sort -n | tail -1)
        
            if [ -z "$HIGHEST_PATCH" ]; then
              PATCH=0
            elif [ "$IS_DRAFT" == "true" ]; then
              PATCH=$HIGHEST_PATCH
            else
              PATCH=$((HIGHEST_PATCH + 1))
            fi
          fi
        
          FULL_VERSION="${BASE_VERSION}.${PATCH}"
        
          echo "BASE_VERSION=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT

  build-windows:
    needs: get-version
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache .deps and build directory
        uses: actions/cache@v5.0.3
        with:
          path: |
            out/build
            .deps
          key: ${{ runner.os }}-build-${{ hashFiles('CMakeLists.txt', '**/*.cmake') }}
          restore-keys: ${{ runner.os }}-build-

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: cmake --preset windows -DJAS_PATCH_INDEX=${{ needs.get-version.outputs.patch_number }}

      - name: Build Release
        run: cmake --build --preset release-windows

      - name: Restore signing certificate
        shell: pwsh
        run: |
          $cert = "${{ secrets.WINDOWS_PFX_BASE64 }}"
          [IO.File]::WriteAllBytes("cert.pfx",[Convert]::FromBase64String($cert))

      - name: Sign VST3 binary
        run: |
          signtool sign `
            /f cert.pfx `
            /p "${{ secrets.WINDOWS_PFX_PASSWORD }}" `
            /fd SHA256 `
            /tr http://timestamp.digicert.com `
            /td SHA256 `
            "out\build\windows\JustASample_artefacts\Release\VST3\Just a Sample.vst3\Contents\x86_64-win\Just a Sample.vst3"

      - name: Install 7-Zip
        run: choco install 7zip -y

      - name: Zip Windows VST3
        run: |
          cd "out\build\windows\JustASample_artefacts\Release\VST3"
          7z a -tzip "${{ github.workspace }}\JAS.Windows.VST3.v${{ needs.get-version.outputs.full_version }}.zip" "Just a Sample.vst3"

      - name: Build Windows Installer
        run: iscc "Releases\Windows\installer_setup.iss" /DMyAppVersion="${{ needs.get-version.outputs.full_version }}" /DSourceDir="${{ github.workspace }}"

      - name: Sign installer
        run: |
          signtool sign `
            /f cert.pfx `
            /p "${{ secrets.WINDOWS_PFX_PASSWORD }}" `
            /fd SHA256 `
            /tr http://timestamp.digicert.com `
            /td SHA256 `
            "Releases\Windows\Output\Install Just a Sample.exe"

      - name: Cleanup certificate
        run: del cert.pfx

      - name: Zip Windows Installer
        run: |
          cd "Releases\Windows\Output"
          7z a -tzip "${{ github.workspace }}\Install.Just.a.Sample.Windows.v${{ needs.get-version.outputs.full_version }}.zip" "Install Just a Sample.exe"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            JAS.Windows.VST3.v${{ needs.get-version.outputs.full_version }}.zip
            Install.Just.a.Sample.Windows.v${{ needs.get-version.outputs.full_version }}.zip

  build-linux:
    needs: get-version
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache .deps and build directory
        uses: actions/cache@v5.0.3
        with:
          path: |
            out/build
            .deps
          key: ${{ runner.os }}-build-${{ hashFiles('CMakeLists.txt', '**/*.cmake') }}
          restore-keys: ${{ runner.os }}-build-

      - name: Install JUCE Linux Dependencies
        run: chmod +x Releases/Linux/install-dependencies.sh && ./Releases/Linux/install-dependencies.sh

      - name: Configure CMake
        run: cmake --preset linux -DJAS_PATCH_INDEX=${{ needs.get-version.outputs.patch_number }}

      - name: Build Release
        run: cmake --build --preset release-linux

      - name: Zip Linux VST3
        run: |
          cd "out/build/linux/JustASample_artefacts/VST3"
          zip -r "${{ github.workspace }}/JAS.Linux.VST3.v${{ needs.get-version.outputs.full_version }}.zip" "Just a Sample.vst3"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: JAS.Linux.VST3.v${{ needs.get-version.outputs.full_version }}.zip

  publish-release:
    needs: [get-version, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create or Update Release
        uses: ncipollo/release-action@v1.20.0
        with:
          tag: "v${{ needs.get-version.outputs.base_version }}-latest"
          name: "Just A Sample v${{ needs.get-version.outputs.base_version }} Latest"
          artifacts: "artifacts/*"
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: true
          draft: true
          omitBodyDuringUpdate: true